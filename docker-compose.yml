services:
  wggbot:
    container_name: wggbot
    image: ubuntu:22.04
    working_dir: /app
    volumes:
      - ./:/app
    command: >
      bash -c "
        echo 'ğŸ”§ Restoring Ubuntu apt sources...' &&
        echo 'deb http://archive.ubuntu.com/ubuntu jammy main universe' > /etc/apt/sources.list &&
        echo 'deb http://archive.ubuntu.com/ubuntu jammy-updates main universe' >> /etc/apt/sources.list &&
        echo 'deb http://archive.ubuntu.com/ubuntu jammy-security main universe' >> /etc/apt/sources.list &&

        echo 'ğŸ“¦ Updating apt...' &&
        apt-get update -y &&

        echo 'ğŸ“¦ Installing certs + base deps + screen...' &&
        apt-get install -y ca-certificates xz-utils ffmpeg curl wget gnupg screen &&
        update-ca-certificates &&

        echo 'ğŸ”¥ Extracting portable python...' &&
        mkdir -p /app/resources/python313/extracted &&
        tar -xf /app/resources/python313/cpython-3.13.7linux.tar.xz -C /app/resources/python313 &&

        echo 'ğŸ Creating venv using portable python...' &&
        /app/resources/python313/python/bin/python3 -m venv /app/venv &&

        echo 'ğŸ“¦ Activating venv and installing requirements + Playwright...' &&
        source /app/venv/bin/activate &&
        pip install --upgrade pip &&
        pip install -r requirements.txt &&

        echo 'ğŸŒ Installing Playwright browsers...' &&
        playwright install &&

        echo 'ğŸ“¦ Installing Playwright Linux deps...' &&
        playwright install-deps &&

        echo 'ğŸš€ Starting bot...' &&
        exec /app/venv/bin/python /app/main.py
      "
    restart: unless-stopped
