#!/usr/bin/env bash
set -Eeuo pipefail

# Require sudo
if [[ $EUID -ne 0 ]]; then
    echo "‚ùå Run with sudo:  sudo ./dbot"
    exit 1
fi

CONTAINER="wggbot"
COMPOSE="docker-compose.yml"

pause() { read -rp "Press ENTER to continue..."; }

# -------------------------------
# Docker helpers
# -------------------------------
container_exists() {
    docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER}$"
}

container_running() {
    docker ps --format '{{.Names}}' | grep -q "^${CONTAINER}$"
}

bot_running() {
    docker exec "$CONTAINER" pgrep -f "python .*main.py" >/dev/null 2>&1
}

start_bot_inside() {
    echo "üöÄ Starting bot inside container..."
    docker exec -d "$CONTAINER" bash -lc "source /app/venv/bin/activate && python /app/main.py"
}

attach_logs() {
    echo "üìú Attaching to logs (Ctrl+C to detach)..."
    docker logs -f "$CONTAINER"
}

# -------------------------------
# ACTION: START
# -------------------------------
action_start() {

    echo "üîç Checking container state..."

    # Create container if missing
    if ! container_exists; then
        echo "üì¶ Container not found ‚Äî creating with compose..."
        docker compose -f "$COMPOSE" up -d
        echo "‚è≥ Waiting for container boot..."
        sleep 2

        echo "üöÄ Starting bot..."
        start_bot_inside

        attach_logs
        return
    fi

    # If exists but not running -> start container
    if ! container_running; then
        echo "üê≥ Starting container..."
        docker start "$CONTAINER"
        echo "üöÄ Starting bot..."
        start_bot_inside
        attach_logs
        return
    fi

    # If bot already running
    if bot_running; then
        echo "‚ö†Ô∏è Bot is already running inside container."
        attach_logs
        return
    fi

    # If container is running but bot is not
    echo "üê≥ Container running ‚Äî starting bot..."
    start_bot_inside
    attach_logs
}

# -------------------------------
# ACTION: STOP
# -------------------------------
action_stop() {
    if ! container_exists; then
        echo "‚ùå Container does not exist."
        pause
        return
    fi

    if ! container_running; then
        echo "‚ùå Container is not running."
        pause
        return
    fi

    if ! bot_running; then
        echo "‚ö†Ô∏è Bot is NOT running."
        pause
        return
    fi

    echo "‚õî Stopping bot..."
    docker exec "$CONTAINER" pkill -f "python .*main.py" || true
    pause
}

# -------------------------------
# ACTION: RESTART
# -------------------------------
action_restart() {
    action_stop
    sleep 1
    action_start
}

# -------------------------------
# ACTION: CONTAINER SHELL
# -------------------------------
action_shell() {
    if ! container_exists; then echo "‚ùå Container does not exist."; pause; return; fi
    docker exec -it "$CONTAINER" bash
}

# -------------------------------
# ACTION: VIEW LOGS
# -------------------------------
action_logs() {
    if ! container_running; then echo "‚ùå Container not running."; pause; return; fi
    docker logs -f "$CONTAINER"
}

# -------------------------------
# ACTION: DESTROY CONTAINER
# -------------------------------
action_destroy_container() {

    echo "‚ö†Ô∏è WARNING: This will completely destroy:"
    echo "   ‚Ä¢ Docker container"
    echo "   ‚Ä¢ Docker volumes for this project"
    echo "   ‚Ä¢ local venv directory"
    echo "   ‚Ä¢ extracted portable python"

    read -rp "Type YES to confirm: " confirm
    if [[ "$confirm" != "YES" ]]; then
        echo "‚ùå Aborted."
        pause
        return
    fi

    echo "üß® Taking down container with docker compose..."
    docker compose -f "$COMPOSE" down || true

    echo "üóë Removing local venv directory..."
    rm -rfv venv || true

    echo "üóë Removing extracted portable python..."
    rm -rfv resources/python313/extracted || true

    echo "‚úî Destroy complete."
    pause
}

# -------------------------------
# MENU
# -------------------------------
while true; do
    clear
    echo "======================================="
    echo "          DBOT DOCKER MANAGER"
    echo "======================================="
    echo "[1] Start Bot (attach to logs)"
    echo "[2] Stop Bot"
    echo "[3] Restart Bot"
    echo "[4] Shell Into Container"
    echo "[5] View Logs"
    echo "[6] Destroy Container + Wipe Environment"
    echo "[Q] Quit"
    echo "---------------------------------------"
    read -rp "Select an option: " choice

    case "${choice,,}" in
        1) action_start ;;
        2) action_stop ;;
        3) action_restart ;;
        4) action_shell ;;
        5) action_logs ;;
        6) action_destroy_container ;;
        q) exit 0 ;;
    esac
done
