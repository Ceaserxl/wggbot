#!/usr/bin/env bash
set -Eeuo pipefail

# Require sudo
if [[ $EUID -ne 0 ]]; then
    echo "‚ùå Run with sudo:  sudo ./dbot"
    exit 1
fi

CONTAINER="wggbot"
COMPOSE="docker-compose.yml"
SCRAPER_SCREEN="scraper"

pause() { read -rp "Press ENTER to continue..."; }

# -------------------------------
# Docker helpers
# -------------------------------
container_exists() {
    docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER}$"
}

container_running() {
    docker ps --format '{{.Names}}' | grep -q "^${CONTAINER}$"
}

bot_running() {
    docker exec "$CONTAINER" pgrep -f "python .*main.py" >/dev/null 2>&1
}

scraper_running() {
    docker exec "$CONTAINER" bash -lc "screen -list | grep -q '\.${SCRAPER_SCREEN}'"
}

start_bot_inside() {
    echo "üöÄ Starting bot inside container..."
    docker exec -d "$CONTAINER" bash -lc "source /app/venv/bin/activate && python /app/main.py"
}

attach_logs() {
    echo "üìú Attaching to logs (Ctrl+C to detach)..."
    docker logs -f "$CONTAINER"
}

# -------------------------------
# ACTION: START BOT
# -------------------------------
action_start() {

    echo "üîç Checking container state..."

    if ! container_exists; then
        echo "üì¶ Container not found ‚Äî creating with compose..."
        docker compose -f "$COMPOSE" up -d
        echo "‚è≥ Waiting for container boot..."
        sleep 2

        echo "üöÄ Starting bot..."
        start_bot_inside
        attach_logs
        return
    fi

    if ! container_running; then
        echo "üê≥ Starting container..."
        docker start "$CONTAINER"
        echo "üöÄ Starting bot..."
        start_bot_inside
        attach_logs
        return
    fi

    if bot_running; then
        echo "‚ö†Ô∏è Bot is already running inside container."
        attach_logs
        return
    fi

    echo "üê≥ Container running ‚Äî starting bot..."
    start_bot_inside
    attach_logs
}

# -------------------------------
# ACTION: STOP BOT
# -------------------------------
action_stop() {
    if ! container_exists; then echo "‚ùå Container does not exist."; pause; return; fi
    if ! container_running; then echo "‚ùå Container is not running."; pause; return; fi

    if ! bot_running; then
        echo "‚ö†Ô∏è Bot is NOT running."
        pause
        return
    fi

    echo "‚õî Stopping bot..."
    docker exec "$CONTAINER" pkill -f "python .*main.py" || true
    pause
}

# -------------------------------
# ACTION: RESTART BOT
# -------------------------------
action_restart() {
    action_stop
    sleep 1
    action_start
}

# -------------------------------
# ACTION: SHELL INTO CONTAINER
# -------------------------------
action_shell() {
    if ! container_exists; then echo "‚ùå Container does not exist."; pause; return; fi
    docker exec -it "$CONTAINER" bash -lc "source /app/venv/bin/activate && exec bash"
}

# -------------------------------
# ACTION: VIEW CONTAINER LOGS
# -------------------------------
action_logs() {
    if ! container_running; then echo "‚ùå Container not running."; pause; return; fi
    docker logs -f "$CONTAINER"
}

# -------------------------------
# ACTION: RUN SCRAPER
# -------------------------------
action_run_scraper() {

    if ! container_exists; then echo "‚ùå Container does not exist."; pause; return; fi

    read -rp "Enter tags (space-separated): " raw_tags
    if [[ -z "$raw_tags" ]]; then
        echo "‚ùå No tags provided."
        pause
        return
    fi

    TAG_ARGS=""
    for t in $raw_tags; do
        TAG_ARGS="$TAG_ARGS \"$t\""
    done

    echo "üöÄ Launching scraper in screen session '${SCRAPER_SCREEN}'..."

    docker exec "$CONTAINER" bash -lc "
        screen -S ${SCRAPER_SCREEN} -dm bash -lc '
            source /app/venv/bin/activate &&
            cd /app &&
            python modules/scraper/scraper/main.py ${TAG_ARGS}
        '
    "

    echo "üì∫ Scraper running in detached screen '${SCRAPER_SCREEN}'."
    echo "‚û° Attach: docker exec -it $CONTAINER screen -r ${SCRAPER_SCREEN}"
    pause
}

# -------------------------------
# ACTION: ATTACH TO SCRAPER
# -------------------------------
action_attach_scraper() {

    if ! container_exists; then echo "‚ùå Container does not exist."; pause; return; fi

    if ! scraper_running; then
        echo "‚ùå No scraper session is running."
        pause
        return
    fi

    echo "üì∫ Attaching to scraper screen..."
    docker exec -it "$CONTAINER" screen -r "${SCRAPER_SCREEN}"
}

# -------------------------------
# ACTION: DESTROY CONTAINER
# -------------------------------
action_destroy_container() {

    echo "‚ö†Ô∏è WARNING: This will completely destroy:"
    echo "   ‚Ä¢ Docker container"
    echo "   ‚Ä¢ Docker volumes"
    echo "   ‚Ä¢ local venv directory"
    echo "   ‚Ä¢ extracted portable python"

    read -rp "Type YES to confirm: " confirm
    if [[ "$confirm" != "YES" ]]; then echo "‚ùå Aborted."; pause; return; fi

    echo "üß® Taking down container..."
    docker compose -f "$COMPOSE" down || true

    echo "üóë Removing venv..."
    rm -rfv venv || true

    echo "üóë Removing extracted portable python..."
    rm -rfv resources/python313/extracted || true

    echo "‚úî Destroy complete."
    pause
}

# -------------------------------
# MENU
# -------------------------------
while true; do
    clear
    echo "======================================="
    echo "          DBOT DOCKER MANAGER"
    echo "======================================="
    echo "[1] Start Bot (attach to logs)"
    echo "[2] Stop Bot"
    echo "[3] Restart Bot"
    echo "[4] Shell Into Container"
    echo "[5] View Logs"
    echo "[6] Destroy Container + Wipe Environment"
    echo "[7] Run Scraper (space-separated tags)"
    echo "[8] Attach to Scraper"
    echo "[Q] Quit"
    echo "---------------------------------------"
    read -rp "Select an option: " choice

    case "${choice,,}" in
        1) action_start ;;
        2) action_stop ;;
        3) action_restart ;;
        4) action_shell ;;
        5) action_logs ;;
        6) action_destroy_container ;;
        7) action_run_scraper ;;
        8) action_attach_scraper ;;
        q) exit 0 ;;
    esac
done
